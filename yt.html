<html>
  <head>
    <script src='https://cdn.firebase.com/v0/firebase.js'></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
    <script src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js" ></script>
    <script>
      var dataRef = new Firebase("https://sudarshan.firebaseio.com/");
      var ytplayer = null;
      var ignore = false;
      var receiving = false;

      dataRef.on('value', function(data){
        console.log("inc");
        data = data.val();
        console.log( data );

        ytplayer.seekTo(data.seek);
        if (data.playing)
          ytplayer.playVideo();
        else
          ytplayer.pauseVideo();
      });
      
      function doClick() {
        //playing = !playing;
        //dataRef.set(playing, function(result){
        //  playPause();
        //});
        var play = ytplayer.getPlayerState() == 1;

        var time = ytplayer.getCurrentTime();
        var now = new Date().getTime() / 1000;
        var data = {seek: time, time: now, playing: play};

        console.log("out");
        console.log(data);

        dataRef.set(data, function(result){
          //playPause();
        });
      }
      window.onload = function(){
        var params = { allowScriptAccess: "always" };
        var atts = { id: "myytplayer" };
        swfobject.embedSWF("http://www.youtube.com/apiplayer?video_id=hT_nvWreIhg&version=3&enablejsapi=1&playerapiid=ytplayer&version=3", "ytapiplayer", "425", "356", "8", null, null, params, atts);            
      }
      function onYouTubePlayerReady(playerId) {
        ytplayer = $("#myytplayer")[0];

        ytplayer.addEventListener("onStateChange", "stateListener"); 
      }
      function stateListener (value){
        if (ignore || receiving){
          console.log("ignoring");
          return;
        }
        switch (value)
        {
          case -1:
            console.log("unstarted");
            return;
            break;
          case 0:
            console.log("ended");
            return;
            break;
          case 1:
            console.log("playing");
            break;
          case 2:
            console.log("paused");
            break;
          case 3:
            console.log("buffering");
            break;
          case 5:
            console.log("cued");
            return;
            break;
        }

        var time = ytplayer.getCurrentTime();
        var now = new Date().getTime() / 1000;
        var data = {seek: time, time: now, playing: value==1};

        console.log("out");
        console.log(data);

        dataRef.set({seek: time, time: now, playing: true}, function(result){
          playPause();
        });

      };
    </script>
  </head>
  <body>
  <button onclick="doClick()" >Play/Pause</button>
  <div id="ytapiplayer">
     You need Flash player 8+ and JavaScript enabled to view this video.
   </div>
  </body>
</html>